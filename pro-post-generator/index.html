<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<!-- v12: Ensure correct viewport for responsiveness -->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pro Post Generator — Quotesn Studio</title>

<!-- Canonical + SEO --><link rel="canonical" href="https://www.quotesn.com/pro-post-generator"/>
<!-- Polished Meta Description for SERP -->
<meta name="title" content="Pro Post Generator — Create Shareable Quote Posters Instantly">
<meta name="description" content="Instantly design and export beautiful, high-quality quote posters with curated themes, unique fonts, and professional text effects.">

<!-- Open Graph --><meta property="og:type" content="website">
<meta property="og:title" content="Pro Post Generator — Quotesn Studio">
<meta property="og:description" content="Create beautiful quote posters. Themes, watermark, retina export, and more.">
<meta property="og:url" content="https://www.quotesn.com/pro-post-generator">
<meta property="og:image" content="https://www.quotesn.com/assets/og-pro-post.png">

<!-- Twitter --><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Pro Post Generator — Quotesn Studio">
<meta name="twitter:description" content="Create beautiful quote posters. Themes, watermark, retina export, and more.">
<meta name="twitter:image" content="https://www.quotesn.com/assets/og-pro-post.png">

<!-- JSON-LD --><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Pro Post Generator — Quotesn Studio",
  "applicationCategory": "DesignApplication",
  "operatingSystem": "Web",
  "url": "https://www.quotesn.com/pro-post-generator",
  "description": "Create export-accurate quote posters with curated themes, unique fonts, watermark, and retina PNG/JPG/WEBP.",
  "publisher": { "@type": "Organization", "name": "Quotesn" }
}
</script>

<!-- Favicon (Verified) --><link rel="icon" href="https://www.quotesn.com/images/favicon.ico" type="image/x-icon"/>

<!-- Tailwind + html2canvas --><script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- v14: Added Pacifico and Bebas Neue -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lora:wght@400;600&family=Montserrat:wght@400;600&family=Inter:wght@400;600;700&family=Noto+Serif:wght@400;600&family=Noto+Serif+Display:wght@400;600&family=Playfair+Display:wght@400;700&family=Roboto+Slab:wght@400;700&family=Merriweather:wght@400;700&family=Dancing+Script:wght@400;700&family=Pacifico&family=Bebas+Neue&display=swap" rel="stylesheet"/>

<style>
:root{
  --panel-bg:#fff;--panel-border:#e5e7eb;--muted:#64748b;
  --pad: 60px; /* v10: Standardized padding */
  --poster-max: 576px; /* v14: Constrained layout (was 768px) */
}
html,body{height:100%}
/* v15: Enhanced App Background */
body{font-family:Inter,ui-sans-serif,system-ui;color:#0f172a; background-color: #f8f9fa; background-image: radial-gradient(circle at 100% 0, #eef2f7 0%, #f8f9fa 50%);}

/* Header */
.studio{background:#ffffffe6;backdrop-filter:blur(10px);border-bottom:1px solid var(--panel-border);box-shadow:0 4px 18px rgba(0,0,0,.06)}
.icon-purple{color:#4f46e5}

/* Panels */
.panel{background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
.field{
  border:1px solid var(--panel-border);
  background:#fff;
  border-radius:10px;
  transition: border-color .2s ease;
}
.field:hover {
  border-color: #a5b4fc; /* indigo-300 */
}
.subtle{color:var(--muted)}
.swatch{height:56px;border-radius:12px;border:1px solid #e5e7eb}

/* Poster & canvas */
.ratio-box{position:relative;width:100%;max-width:var(--poster-max);margin:0 auto}
.ratio-spacer{width:100%}
.abs{position:absolute;inset:0}
/* v12: Responsive border radius */
#poster{position:absolute;inset:0;border-radius:24px;padding:var(--pad);display:flex;text-align:center;box-shadow:0 22px 80px rgba(15,23,42,.12);overflow:hidden}
@media (min-width: 640px) {
  #poster {
    border-radius: 32px;
  }
}
#content{width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding-bottom: 50px;} /* v10: Fixed padding */

/* === POLISHED TYPOGRAPHY & LAYOUT === */
#headline{
  font-family:"Noto Serif Display",serif;
  font-weight:400;
  line-height:1.15;
  letter-spacing:.1px;
  margin:0 0 1.5rem;
  overflow-wrap: break-word;
  word-break: break-word;
}
#author{
  font-family:"Inter", sans-serif;
  font-size:28px;
  opacity:.9;
  margin:0;
  transition: all 0.2s ease-in-out;
}
/* === END POLISH === */

/* v14: Increased watermark font size */
#wmark{position:absolute;font-size:16px;opacity:.65;pointer-events:none;bottom:var(--pad);right:var(--pad)}
#wmarkLogo {
  position: absolute;
  max-height: 40px; /* Limit logo size */
  max-width: 120px; /* Limit logo size */
  opacity: .65;
  pointer-events: none;
}
.align.active{outline:2px solid #6366f1;outline-offset:2px}
.ap-pos.active{outline:2px solid #6366f1;outline-offset:2px}

/* Secondary action buttons (used in panels) */
.btn-action{display:flex;align-items:center;justify-content:center;gap:.6rem;font-weight:600;border-radius:14px;padding:.7rem 1.1rem;border:1px solid #e5e7eb;transition:all .2s ease}
.btn-action:hover{background:#eef2ff;box-shadow:0 6px 20px rgba(99,102,241,.22)}
.btn-action svg{width:18px;height:18px}
.btn-action svg.w-5.h-5 { width: 20px; height: 20px; }

/* NEW: Primary action buttons (below poster) */
.btn-primary-action {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem; /* 12px */
  font-weight: 600;
  border-radius: 16px; /* xl */
  padding: 0.875rem 1.5rem; /* 14px 24px */
  transition: all 0.25s ease;
  transform: translateZ(0); /* For GPU acceleration */
  box-shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 3px rgba(0,0,0,.05);
}
.btn-primary-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(99,102,241,.25), 0 4px 8px rgba(0,0,0,.08);
}
.btn-primary-action:active {
  transform: translateY(0);
  box-shadow: 0 4px 12px rgba(0,0,0,.08), 0 1px 3px rgba(0,0,0,.05);
}
.btn-primary-action svg {
  width: 20px; /* 5 */
  height: 20px; /* 5 */
}


/* Focus ring */
:focus-visible{outline:3px solid #6366f1;outline-offset:2px}

/* Custom Select Arrow (FIXED) */
select.field,
select.btn-primary-action {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor' class='w-5 h-5'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
  background-position: right 0.75rem center; /* Adjusted position */
  background-repeat: no-repeat;
  background-size: 1.25em;
}

select.field {
  /* Consolidate padding (from Tailwind's px-3, py-2) */
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  padding-left: 0.75rem;
  padding-right: 2.5rem; /* Make space for arrow */
}

/* v9: Style for select as a primary action */
select.btn-primary-action {
  padding-right: 3.5rem;
}


/* Custom Color Picker */
.color-picker-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.25rem 0.35rem 0.25rem 0.75rem; /* p-1 pl-3 pr-1.5 */
}
.color-picker-wrapper input[type="color"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 32px; /* w-8 */
  height: 32px; /* h-8 */
  padding: 0;
  border: none;
  border-radius: 8px; /* rounded-lg */
  background: transparent;
  cursor: pointer;
}
.color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
  padding: 0;
  border-radius: 8px;
}
.color-picker-wrapper input[type="color"]::-webkit-color-swatch {
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 8px;
}
.color-picker-wrapper input[type="color"]::-moz-color-swatch {
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 8px;
}


/* ======= UI POLISH PATCH v3.7 (ENHANCED ICONS) ======= */

/* --- Header icons refinement (ENHANCED) --- */
.icon-btn {
  position: relative;
  display:flex;align-items:center;justify-content:center;
  width:44px;height:44px;border-radius:14px;
  border:1px solid var(--panel-border);background:#fff;
  transition:all .2s ease;
  box-shadow:0 1px 3px rgba(0,0,0,.04); /* NEW subtle shadow */
}
.icon-btn:hover {
  transform:translateY(-2px); /* Increased lift */
  box-shadow:0 6px 14px rgba(79,70,229,.20); /* Brighter hover shadow */
}
.icon-btn.active {
  background:linear-gradient(135deg,#eef2ff,#e0e7ff);
  box-shadow:0 2px 8px rgba(79,70,229,.30); /* Tighter active shadow */
  transform: translateY(-1px);
}
.icon-btn svg {
  width:22px;height:22px;stroke-width:2;transition:transform .2s;
}
/* Specific fix for SVG logo size */
.icon-btn img {
  width: 22px; height: 22px;
}
.icon-btn:hover svg { transform:scale(1.07); }

/* --- Dropdown visibility & layering --- */
#exportMenu, #exportMenu2 {
  z-index: 60; /* ensure always above panels */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(15,23,42,.15);
  animation:fadeIn .15s ease-out;
}
@keyframes fadeIn {from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:none;}}

/* --- Watermark position buttons (IMPROVED) --- */
.wm-choices {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:.75rem;
}
.wm-choices button {
  border:1px solid #e2e8f0;
  border-radius:14px;
  background:#fff;
  padding:.7rem .9rem; /* Kept padding */
  transition:all .18s ease;
  display:flex;align-items:center;justify-content:center;
}
.wm-choices button:hover {
  box-shadow:0 4px 10px rgba(99,102,241,.15);
  border-color:#c7d2fe;
}
.wm-choices button.active {
  border-color:#4f46e5;
  background:#eef2ff;
  box-shadow:0 0 0 2px #4f46e5 inset;
}
/* Removed old .dot and .bar styles */
.wm-choices .dot { display: none; }
.wm-choices .bar { display: none; }

/* NEW Visual Watermark Styles */
.wm-preview {
  width: 64px;
  height: 48px; /* 4:3 aspect ratio */
  border: 2px solid #cbd5e1; /* slate-300 */
  border-radius: 6px;
  position: relative;
  background: #f8fafc; /* slate-50 */
}
.wm-preview div {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #a5b4fc; /* indigo-300 */
  transition: background-color 0.2s ease;
}
.wm-choices button.active .wm-preview div {
  background: #4f46e5; /* indigo-700 */
}
.dot-bl { bottom: 4px; left: 4px; }
.dot-bc { bottom: 4px; left: 50%; transform: translateX(-50%); }
.dot-br { bottom: 4px; right: 4px; }
/* === END Watermark --- */

/* --- Subtle Motion Layer --- */
#poster {
  transition: all .35s ease;
  transform: scale(.99);
  opacity: 0;
}
#poster.loaded {
  opacity: 1;
  transform: scale(1);
}

/* --- Optional visual accent --- */
.icon-btn.active::after {
  content:"";
  position:absolute;inset:-4px;border-radius:16px;
  background:radial-gradient(ellipse at center,rgba(99,102,241,.15),transparent 60%);
  z-index:-1;
}
/* ======= END OF PATCH ======= */

</style>
</head>
<body>
<!-- Header --><header class="studio sticky top-0 z-40">
  <!-- v12: Responsive header padding -->
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- Updated Logo -->
      <img src="https://www.quotesn.com/images/quotesn-logo.svg" alt="Quotesn Logo" class="w-8 h-8" loading="lazy"/>
      <span class="font-semibold text-[15px]">Pro Post Generator</span>
    </div>
    <!-- v12: Responsive header gap -->
    <div class="flex items-center gap-2 sm:gap-3">
      
      <!-- Home Link -->
      <a href="https://www.quotesn.com/" class="icon-btn" aria-label="Back to Quotesn Home" title="Back to Quotesn Home">
        <svg class="icon-purple" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </a>
      
      <!-- "New Post" Button -->
      <button id="newPostBtn" class="icon-btn" aria-label="New Post (Reset)" title="New Post (Reset)">
        <svg class="icon-purple" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
      </button>

      <!-- Sparkle Shuffle = Next Theme (T) --><button id="toggleTheme" class="icon-btn" aria-label="Change Theme (T)" title="Change Theme (T)">
        <!-- CORRECTED SPARKLE ICON (FROM SCREENSHOT) -->
        <svg class="icon-purple" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 4.5l.6 2.1a4 4 0 0 0 2.3 2.7L12 10l-1.6.7a4 4 0 0 0-2.3 2.7L7.5 15.5l-.6-2.1a4 4 0 0 0-2.7-2.3L2 10l2.2-.6a4 4 0 0 0 2.7-2.7L7.5 4.5Z"/>
          <path stroke-linecap="round" stroke-width="2" d="M16.5 3.5l.3 1.2a3 3 0 0 0 2 2l1.2.3-1.2.3a3 3 0 0 0-2 2l-.3 1.2-.3-1.2a3 3 0 0 0-2-2l-1.2-.3 1.2-.3a3 3 0 0 0 2-2l.3-1.2Z"/>
        </svg>
      </button>

      <!-- Download menu (D) --><div class="relative">
        <button id="exportBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" aria-controls="exportMenu" aria-label="Download (D)" title="Download (D)">
          <!-- NEW ENHANCED DOWNLOAD ICON -->
          <svg class="icon-purple" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
        <div id="exportMenu" class="hidden absolute right-0 mt-2 w-44 panel p-2" role="menu">
          <button data-type="png" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">PNG (transparent)</button>
          <button data-type="jpeg" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">JPG (solid)</button>
          <button data-type="webp" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">WEBP</button>
        </div>
      </div>

      <!-- Share (S) - Corrected Icon --><button id="shareBtn" class="icon-btn" aria-label="Share (S)" title="Share (S)">
        <!-- NEW ENHANCED SHARE ICON -->
        <svg class="icon-purple" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Poster --><!-- v12: Responsive main padding -->
<main class="max-w-7xl mx-auto px-4 py-8 sm:py-12">
  <div class="ratio-box">
    <div id="ratioSpacer" class="ratio-spacer" style="padding-top:100%"></div> <!-- v9 default 1:1 -->
    <div class="abs">
      <div id="poster" style="background:linear-gradient(135deg,#141E30,#243B55);color:#f5f3ff;"> <!-- v9 default Royal Ink -->
        <div id="content" style="padding-bottom: 50px;">
          <h1 id="headline" style="font-size:50px;">Stay focused. Ship value. Repeat.</h1>
          <p id="author" style="font-size: 28px;">— Quotesn</p>
        </div>
        <div id="wmark">quotesn.com</div>
        <img id="wmarkLogo" class="hidden"/>
      </div>
    </div>
  </div>
  <p id="status" class="text-center text-sm text-indigo-600 mt-4 h-6" aria-live="polite"></p>
</main>

<!-- NEW: Primary Action Buttons --><!-- v12: Responsive flex direction -->
<section class="max-w-7xl mx-auto px-4 pb-4 sm:pb-8 -mt-4 sm:-mt-8">
  <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
    
    <button id="themeNextBtn" class="btn-primary-action w-full sm:w-auto bg-white text-indigo-700 border border-gray-200 hover:bg-indigo-50" aria-label="Change Theme">
      <!-- CORRECTED SPARKLE ICON (FROM SCREENSHOT) -->
      <svg class="text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 4.5l.6 2.1a4 4 0 0 0 2.3 2.7L12 10l-1.6.7a4 4 0 0 0-2.3 2.7L7.5 15.5l-.6-2.1a4 4 0 0 0-2.7-2.3L2 10l2.2-.6a4 4 0 0 0 2.7-2.7L7.5 4.5Z"/>
        <path stroke-linecap="round" stroke-width="2" d="M16.5 3.5l.3 1.2a3 3 0 0 0 2 2l1.2.3-1.2.3a3 3 0 0 0-2 2l-.3 1.2-.3-1.2a3 3 0 0 0-2-2l-1.2-.3 1.2-.3a3 3 0 0 0 2-2l.3-1.2Z"/>
      </svg>
      Change Theme
    </button>
    
    <div class="relative w-full sm:w-auto">
      <button id="downloadBtn" class="btn-primary-action w-full bg-indigo-600 text-white hover:bg-indigo-700" aria-haspopup="menu" aria-expanded="false" aria-controls="exportMenu2" aria-label="Download">
        <!-- NEW ENHANCED DOWNLOAD ICON -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download Image
      </button>
      <div id="exportMenu2" class="hidden absolute left-0 mt-2 w-full panel p-2" role="menu">
        <button data-type="png" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">PNG (transparent)</button>
        <button data-type="jpeg" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">JPG (solid)</button>
        <button data-type="webp" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">WEBP</button>
      </div>
    </div>
    
    <!-- NEW EXPORT RESOLUTION DROPDOWN (v9) -->
    <div class="relative w-full sm:w-auto">
      <select id="exportRes" class="btn-primary-action w-full sm:w-auto bg-white text-gray-700 border border-gray-200 hover:bg-gray-50" aria-label="Export Resolution">
        <option value="standard" selected>Standard 1080px (1x)</option>
        <option value="hd">HD 2160px (2x)</option>
        <option value="4k">4K 4320px (4x)</option>
      </select>
    </div>

  </div>
</section>

<!-- Panels --><!-- v12: Responsive main grid -->
<section class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 p-4">

  <!-- Content --><div class="panel p-5">
    <div class="space-y-5">
      <h3 class="font-semibold">Content</h3>
      <label class="block">
        <span class="subtle text-sm mb-1 block">Quote</span>
        <textarea id="quoteInput" rows="3" class="field w-full px-3 py-2" aria-label="Quote">Stay focused. Ship value. Repeat.</textarea>
      </label>
      <label class="block">
        <span class="subtle text-sm mb-1 block">Author / Citation</span>
        <input id="authorInput" type="text" class="field w-full px-3 py-2" value="— Quotesn" aria-label="Author"/>
      </label>
    </div>
  </div>

  <!-- Typography & Layout --><div class="panel p-5">
    <div class="space-y-5">
      <h3 class="font-semibold">Layout & Colors</h3>
      
      <!-- Size Sliders --><!-- v12: Responsive panel grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label>
          <span class="subtle text-sm mb-1 block">Headline Size</span>
          <!-- v9: Added Auto-Fit Button -->
          <div class="flex items-center gap-2">
            <input id="sizeInput" type="range" min="24" max="140" value="50" class="w-full accent-indigo-600" aria-label="Headline Size" title="Size: 50px"/>
            <button id="autoFitBtn" class="icon-btn flex-shrink-0 w-10 h-10" title="Auto-Fit Text (A)">
              <!-- v9.1: New Icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="20" y1="4" x2="14" y2="10"></line><line x1="4" y1="20" x2="10" y2="14"></line>
                <polyline points="14 4 20 4 20 10"></polyline><polyline points="10 20 4 20 4 14"></polyline>
              </svg>
            </button>
          </div>
        </label>
        <label>
          <span class="subtle text-sm mb-1 block">Citation Size</span>
          <input id="citationSizeInput" type="range" min="10" max="50" value="28" class="w-full accent-indigo-600" aria-label="Citation Size" title="Size: 28px"/>
        </label>
      </div>

      <!-- Line Height & Padding Sliders --><!-- v12: Responsive panel grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label>
          <span class="subtle text-sm mb-1 block">Line Height</span>
          <input id="lineHeightInput" type="range" min="0.8" max="2.0" value="1.15" step="0.01" class="w-full accent-indigo-600" aria-label="Line Height" title="Height: 1.15"/>
        </label>
        <!-- v10: Removed Padding Slider -->
      </div>

      <!-- Ratio & Colors --><!-- v12: Responsive panel grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <label>
          <span class="subtle text-sm mb-1 block">Aspect Ratio</span>
          <select id="ratioSelect" class="field w-full h-10" aria-label="Aspect Ratio">
            <option value="1:1" selected>Square 1 : 1</option>
            <option value="4:5">Portrait 4 : 5</option>
            <option value="9:16">Story 9 : 16</option>
            <option value="16:9">Landscape 16 : 9</option>
          </select>
        </label>
        <label>
          <!-- v9: Added Contrast Button + Badge -->
          <div class="flex justify-between items-center mb-1">
            <span class="subtle text-sm">Text Color</span>
            <button id="fixContrastBtn" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium" title="Auto-fix contrast to meet WCAG AA">Fix Contrast</button>
          </div>
          <div class="field w-full h-10 color-picker-wrapper">
            <span id="fgHex" class="text-sm pl-1">#ffffff</span>
            <span id="fgContrast" class="text-xs font-medium px-2 py-0.5 rounded-full"></span>
            <input id="fgPicker" type="color" value="#ffffff" aria-label="Text Color"/>
          </div>
        </label>
        <label>
          <span class="subtle text-sm mb-1 block">Background</span>
          <!-- v9: Added Contrast Badge -->
          <div class="field w-full h-10 color-picker-wrapper">
            <span id="bgHex" class="text-sm pl-1">#0b1020</span>
            <span id="bgContrast" class="text-xs font-medium px-2 py-0.5 rounded-full"></span>
            <input id="bgPicker" type="color" value="#0b1020" aria-label="Background Color"/>
          </div>
        </label>
      </div>
      
      <!-- Alignment Controls --><!-- v12: Responsive panel grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
            <span class="subtle text-sm mb-1 block">H-Align</span>
            <div class="flex gap-2">
              <button class="align icon-btn" data-align="left" title="Align Left" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h12M4 12h16M4 18h12" stroke-linecap="round"/></svg>
              </button>
              <button class="align icon-btn active" data-align="center" title="Align Center" aria-pressed="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 6h12M4 12h16M6 18h12" stroke-linecap="round"/></svg>
              </button>
              <button class="align icon-btn" data-align="right" title="Align Right" aria-pressed="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 6h12M4 12h16M8 18h12" stroke-linecap="round"/></svg>
              </button>
            </div>
        </div>
         <div>
            <span class="subtle text-sm mb-1 block">Citation Position</span>
            <div class="flex gap-2">
              <button class="ap-pos icon-btn active" data-pos="bottom" title="Citation Below" aria-pressed="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="16" y2="6"></line><line x1="8" y1="10" x2="16" y2="10"></line><line x1="10" y1="18" x2="14" y2="18"></line><path d="M12 14v4"></path></svg>
              </button>
              <button class="ap-pos icon-btn" data-pos="top" title="Citation Above" aria-pressed="false">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" y1="6" x2="14" y2="6"></line><path d="M12 10V6"></path><line x1="8"Y1="14" x2="16" y2="14"></line><line x1="8" y1="18" x2="16" y2="18"></line></svg>
              </button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Themes & Watermark --><div class="panel p-5">
    <div class="space-y-5">
      <h3 class="font-semibold">Themes & Watermark</h3>

      <label class="block">
        <span class="subtle text-sm mb-1 block">Theme</span>
        <select id="themeSelect" class="field w-full h-10" aria-label="Theme"></select>
      </label>

      <div id="themeGrid" class="grid grid-cols-3 gap-3" aria-label="Theme Grid"></div>

      <!-- Watermark Controls -->
      <div class="grid gap-3">
        <!-- v12: Responsive panel grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block sm:col-span-2">
            <span class="subtle text-sm mb-1 block">Watermark Text</span>
            <input id="wmText" type="text" class="field w-full px-3 py-2" value="quotesn.com" aria-label="Watermark Text"/>
          </label>
          <div>
            <span class="subtle text-sm mb-1 block">Logo</span>
            <input type="file" id="logoUpload" class="hidden" accept="image/png, image/jpeg, image/webp">
            <button id="logoUploadBtn" class="btn-action w-full" aria-label="Upload Logo">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M9.25 13.25a.75.75 0 0 0 1.5 0V4.636l2.955 3.129a.75.75 0 0 0 1.09-1.03l-4.25-4.5a.75.75 0 0 0-1.09 0l-4.25 4.5a.75.75 0 1 0 1.09 1.03L9.25 4.636V13.25Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>
              Upload
            </button>
          </div>
          <div>
            <span class="subtle text-sm mb-1 block">Clear</span>
             <button id="logoClearBtn" class="btn-action w-full" aria-label="Clear Logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.707 7.293a1 1 0 0 0-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 1 0 1.414 1.414L10 11.414l1.293 1.293a1 1 0 0 0 1.414-1.414L11.414 10l1.293-1.293a1 1 0 0 0-1.414-1.414L10 8.586 8.707 7.293Z" clip-rule="evenodd" /></svg>
                Clear
               </button>
          </div>
        </div>

        <div>
          <span class="subtle text-sm mb-1 block">Watermark Position (Bottom)</span>
          <!-- IMPROVED Watermark Position HTML -->
          <div class="wm-choices" role="group" aria-label="Watermark Position">
            <button class="wm-pos" data-pos="bl" aria-pressed="false">
              <div class="wm-preview"><div class="dot-bl"></div></div>
            </button>
            <button class="wm-pos" data-pos="bc" aria-pressed="false">
              <div class="wm-preview"><div class="dot-bc"></div></div>
            </button>
            <button class="wm-pos active" data-pos="br" aria-pressed="true">
              <div class="wm-preview"><div class="dot-br"></div></div>
            </button>
          </div>
        </div>

        <label class="flex items-center gap-2">
          <input id="wmToggle" type="checkbox" class="accent-indigo-600" checked aria-label="Show Watermark"/>
          <span class="subtle text-sm">Show Watermark</span>
        </label>

        <!-- v9: Removed Retina Toggle, replaced with Resolution dropdown -->
      </div>

    </div>
  </div>
</section>

<!-- New Enhanced Footer -->
<footer class="bg-white border-t border-gray-200">
  <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
    <div class="flex justify-center space-x-6">
      <a href="https://www.quotesn.com/" class="text-gray-500 hover:text-gray-600">Home</a>
      <a href="https://www.quotesn.com/about" class="text-gray-500 hover:text-gray-600" rel="noopener" target="_blank">About</a>
      <a href="https://www.quotesn.com/privacy-policy" class="text-gray-500 hover:text-gray-600" rel="noopener" target="_blank">Privacy</a>
      <a href="https://www.quotesn.com/terms-of-service" class="text-gray-500 hover:text-gray-600" rel="noopener" target="_blank">Terms</a>
    </div>
    <p class="mt-8 text-center text-base text-gray-400">&copy; <span id="yy"></span> Quotesn. All rights reserved.</p>
  </div>
</footer>


<script>
const $ = id => document.getElementById(id);

/* ------ Elements ------ */
const els = {
  quoteInput: $('quoteInput'), authorInput: $('authorInput'),
  sizeInput: $('sizeInput'),
  citationSizeInput: $('citationSizeInput'),
  lineHeightInput: $('lineHeightInput'),
  // padInput: $('padInput'), // v10: Removed
  alignBtns: document.querySelectorAll('.align'),
  authorPosBtns: document.querySelectorAll('.ap-pos'),
  ratioSelect: $('ratioSelect'), 
  fgPicker: $('fgPicker'), bgPicker: $('bgPicker'),
  fgHex: $('fgHex'), bgHex: $('bgHex'),
  themeSelect: $('themeSelect'), themeGrid: $('themeGrid'),
  wmText: $('wmText'), wmToggle: $('wmToggle'),
  wmChoices: document.querySelectorAll('.wm-pos'),
  logoUpload: $('logoUpload'),
  logoUploadBtn: $('logoUploadBtn'),
  logoClearBtn: $('logoClearBtn'),
  exportRes: $('exportRes'), // v9: Replaces retinaToggle
  autoFitBtn: $('autoFitBtn'), // v9: New
  fixContrastBtn: $('fixContrastBtn'), // v9: New
  themeNextBtn: $('themeNextBtn'), // Now below poster
  ratioSpacer: $('ratioSpacer'), poster: $('poster'),
  content: $('content'), headline: $('headline'), author: $('author'),
  wmark: $('wmark'),
  wmarkLogo: $('wmarkLogo'),
  newPostBtn: $('newPostBtn'),
  toggleTheme: $('toggleTheme'), exportBtn: $('exportBtn'), exportMenu: $('exportMenu'),
  downloadBtn: $('downloadBtn'), // Now below poster
  exportMenu2: $('exportMenu2'), // Now below poster
  shareBtn: $('shareBtn'),
  status: $('status')
};

document.getElementById('yy').textContent = new Date().getFullYear();

/* ------ Themes v15 (Final Polish & Rebalance) ------ */
const THEMES = [
  {
    name:"Bold Poster",
    bg:"#F0F0F0",fg:"#D82C2C",accent:"#000000",
    headlineStyle: {font:"Bebas Neue, sans-serif", fontWeight: "400", letterSpacing: "2px", fontStyle: "normal", textTransform: "uppercase", lineHeight: "1.0"},
    authorStyle: {font:"Inter, sans-serif", fontWeight: "600", letterSpacing: "1px", textTransform: "uppercase"},
    effect:"hard-shadow" // Will use accent
  },
  {
    name:"Retro Diner",
    bg:"linear-gradient(135deg,#ff9a9e 0%,#fad0c4 99%)",fg:"#1E293B",accent:"#FFFFFF",
    headlineStyle: {font:"Pacifico, cursive", fontWeight: "400", letterSpacing: "0.5px", fontStyle: "normal", textTransform: "none", lineHeight: "1.3"},
    authorStyle: {font:"Montserrat, sans-serif", fontWeight: "600", letterSpacing: "1px", textTransform: "uppercase"},
    effect:"inset-shadow"
  },
  {
    name:"Ink & Parchment",
    bg:"#FDFBFB",fg:"#333333",accent:"#8A6E59",
    headlineStyle: {font:"Dancing Script, cursive", fontWeight: "700", letterSpacing: "0px", fontStyle: "normal", textTransform: "none", lineHeight: "1.2"},
    authorStyle: {font:"Lora, serif", fontWeight: "400", fontStyle: "italic", letterSpacing: "0.2px"},
    effect:"soft-shadow"
  },
  {
    name:"Royal Ink",
    bg:"linear-gradient(135deg,#141E30,#243B55)",fg:"#f5f3ff",accent:"#a5b4fc",
    headlineStyle: {font:"Noto Serif Display, serif", fontWeight: "600", letterSpacing: "0.3px", fontStyle: "normal", textTransform: "none", lineHeight: "1.15"},
    authorStyle: {font:"Inter, sans-serif", fontWeight: "400", letterSpacing: "1.5px", textTransform: "uppercase"},
    effect:"shine"
  },
  // v15: REPLACED "Corporate Swiss" with "Vintage Paper"
  {
    name:"Vintage Paper",
    bg:"#F5EFE6",fg:"#4A443D",accent:"#8A6E59",
    headlineStyle: {font:"Playfair Display, serif", fontWeight: "700", letterSpacing: "1px", fontStyle: "normal", textTransform: "none", lineHeight: "1.2"},
    authorStyle: {font:"Lora, serif", fontWeight: "400", fontStyle: "italic", letterSpacing: "0.2px"},
    effect:"soft-shadow"
  },
  {
    name:"Neon Pulse",
    bg:"linear-gradient(135deg,#0f0c29,#302b63,#24243e)",fg:"#f8fafc",accent:"#00ffff",
    headlineStyle: {font:"Poppins, sans-serif", fontWeight: "600", textTransform: "uppercase", letterSpacing: "2px", fontStyle: "normal", lineHeight: "1.2"},
    authorStyle: {font:"Poppins, sans-serif", fontWeight: "400", textTransform: "uppercase", letterSpacing: "0.5px", fontStyle: "normal"},
    effect:"neon-glow"
  },
  // v15: REPLACED "Brutalist Bloc" with "Cyber Grid"
  {
    name:"Cyber Grid",
    bg:"#000000",fg:"#00FF00",accent:"#00FF00",
    headlineStyle: {font:"Bebas Neue, sans-serif", fontWeight: "400", letterSpacing: "3px", fontStyle: "normal", textTransform: "uppercase", lineHeight: "1.1"},
    authorStyle: {font:"Inter, sans-serif", fontWeight: "400", letterSpacing: "1px", textTransform: "uppercase"},
    effect:"subtle-glow"
  },
  {
    name:"Poetic Mist",
    bg:"linear-gradient(135deg,#654ea3,#eaafc8)",fg:"#FDF2F8",accent:"#FDF2F8",
    headlineStyle: {font:"Merriweather, serif", fontWeight: "300", letterSpacing: "0.5px", fontStyle: "italic", textTransform: "none", lineHeight: "1.35"},
    authorStyle: {font:"Lora, serif", fontWeight: "400", fontStyle: "normal", letterSpacing: "0.2px"},
    effect:"letterpress"
  },
  {
    name:"Oceanic",
    bg:"linear-gradient(135deg,#0f2027,#203a43,#2c5364)",fg:"#E0F2FE",accent:"#38BDF8",
    headlineStyle: {font:"Montserrat, sans-serif", fontWeight: "400", letterSpacing: "1.5px", fontStyle: "normal", textTransform: "uppercase", lineHeight: "1.4"},
    authorStyle: {font:"Montserrat, sans-serif", fontWeight: "600", letterSpacing: "2.5px", textTransform: "uppercase"},
    effect:"soft-glow"
  }
];


// Hardcoded defaults to reset to
const DEFAULTS = {
  theme: 3, // v15: Default to "Royal Ink"
  align: 'center',
  size: 50,
  // pad: 56, // v10: Removed
  ratio: '1:1',
  wmPos: 'br',
  citationSize: 28, // v10: Increased
  lineHeight: 1.15,
  authorPos: 'bottom',
  logoDataBase64: null,
  quote: 'Stay focused. Ship value. Repeat.',
  author: '— Quotesn',
  wmText: 'quotesn.com',
  wmToggle: true,
  exportRes: 'standard',
};

let state = { ...DEFAULTS }; // Start with defaults, will be overridden by restore()

/* ------ Helpers ------ */
const say = m => { els.status.textContent = m; clearTimeout(say._t); say._t = setTimeout(()=>els.status.textContent='',1800); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function rgbToHex(rgb){
  const m=rgb.match(/\d+/g);
  if(!m) return '#000000';
  const hex = '#'+m.slice(0,3).map(x=>(+x).toString(16).padStart(2,'0')).join('');
  return hex;
}
function isRTL(text){return /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(text);} // Hebrew/Arabic/Urdu ranges

/* --- Header icon active state toggle --- */
function setActiveIcon(btn) {
  document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  setTimeout(() => btn.classList.remove('active'), 800);
}

// --- v9: Start Contrast Helpers ---
// Function to parse hex/rgb
function parseColor(color) {
    if (color.startsWith('#')) {
        let hex = color.substring(1);
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        if (hex.length === 6) {
            return [parseInt(hex.substring(0, 2), 16), parseInt(hex.substring(2, 4), 16), parseInt(hex.substring(4, 6), 16)];
        }
    } else if (color.startsWith('rgb')) {
        const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (match) {
            return [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
        }
    }
    // Fallback for linear-gradient: sample the *first* color
    const gradientMatch = color.match(/#(?:[0-9a-fA-F]{3}){1,2}/);
    if (gradientMatch) {
        return parseColor(gradientMatch[0]);
    }
    return [0, 0, 0]; // Default fallback
}

// Calculate relative luminance
function getLuminance(rgb) {
    const [r, g, b] = rgb.map(c => {
        const s = c / 255;
        return (s <= 0.03928) ? s / 12.92 : Math.pow((s + 0.055) / 1.055, 2.4);
    });
    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
}

// Calculate contrast ratio
function getContrast(rgb1, rgb2) {
    const l1 = getLuminance(rgb1);
    const l2 = getLuminance(rgb2);
    return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
}

// v12: Update the UI (Positive-Only Feedback)
function updateContrastIndicator() {
    try {
        const fgColor = els.fgPicker.value;
        const bgColor = els.bgPicker.value;
        
        const fgRgb = parseColor(fgColor);
        const bgRgb = parseColor(bgColor);
        
        const contrast = getContrast(fgRgb, bgRgb);
        
        let badge = '', text = ''; // v12: Default to empty

        if (contrast >= 4.5) {
            badge = 'bg-green-100 text-green-800'; text = 'Good ✓';
        } 
        // v12: Removed 'else if' and 'else' to hide 'Fair' and 'Poor'
        
        let el = $('fgContrast');
        el.className = `text-xs font-medium px-2 py-0.5 rounded-full ${badge}`;
        el.textContent = text;

        el = $('bgContrast');
        el.className = `text-xs font-medium px-2 py-0.5 rounded-full ${badge}`;
        el.textContent = text;
        
    } catch (e) {
        console.error('Contrast check failed', e);
        $('fgContrast').textContent = '';
        $('bgContrast').textContent = '';
    }
}

// v9: Auto-fix contrast
function fixContrast() {
    try {
        const bgRgb = parseColor(els.bgPicker.value);
        let fgRgb = parseColor(els.fgPicker.value);
        
        let currentContrast = getContrast(fgRgb, bgRgb);
        if (currentContrast >= 4.5) {
            say('Contrast is already good');
            return;
        }

        const bgL = getLuminance(bgRgb);
        const targetL = bgL > 0.179 ? 0 : 1; // 0.179 threshold for dark/light
        let isLighter = targetL > getLuminance(fgRgb); // If target is white (1), we need to get lighter
        
        let guard = 20;
        while (currentContrast < 4.5 && guard--) {
            fgRgb = fgRgb.map(c => {
                const newC = isLighter ? c + 10 : c - 10;
                return Math.max(0, Math.min(255, newC));
            });
            currentContrast = getContrast(fgRgb, bgRgb);
            
            // Stop if we hit pure white or black
            if (fgRgb.every(c => c === 255) || fgRgb.every(c => c === 0)) break;
        }

        const newHex = '#' + fgRgb.map(c => c.toString(16).padStart(2, '0')).join('');
        els.fgPicker.value = newHex;
        
        applyColors(); // Apply new color
        say('Contrast fixed');

    } catch (e) {
        console.error('Failed to fix contrast', e);
        say('Auto-fix failed');
    }
}
// --- v9: End Contrast Helpers ---


/* ------ Apply ------ */
function applyTheme(i){
  const t = THEMES[i];
  if (!t) return; // Safety check
  
  state.theme = i; // Set theme index in state
  els.poster.style.background = t.bg;
  els.poster.style.color = t.fg;
  
  // Reset and apply headline styles
  const hs = els.headline.style;
  hs.fontFamily = t.headlineStyle.font;
  hs.fontWeight = t.headlineStyle.fontWeight || 'normal';
  hs.fontStyle = t.headlineStyle.fontStyle || 'normal';
  hs.textTransform = t.headlineStyle.textTransform || 'none';
  hs.letterSpacing = t.headlineStyle.letterSpacing || 'normal';
  hs.textShadow = 'none'; // v9.3: RESET effect
  
  // Apply headline line height from theme
  const newLh = t.headlineStyle.lineHeight || 1.15;
  hs.lineHeight = newLh;
  els.lineHeightInput.value = newLh;
  state.lineHeight = newLh;

  // Reset and apply author styles
  const as = els.author.style;
  as.fontFamily = t.authorStyle.font;
  as.fontWeight = t.authorStyle.fontWeight || 'normal';
  as.fontStyle = t.authorStyle.fontStyle || 'normal';
  as.textTransform = t.authorStyle.textTransform || 'none';
  as.letterSpacing = t.authorStyle.letterSpacing || 'normal';
  
  // v11: BUG FIX - Removed the 4 lines that hardcoded citation font size.
  // The font size is now correctly controlled by the citationSizeInput slider
  // and sourced from state.citationSize.
  
  // v11: APPLY Hybrid theme effects (v14/v15: All effects are covered)
  if(t.effect==='soft-shadow') hs.textShadow='0 2px 8px rgba(0,0,0,0.15)';
  if(t.effect==='hard-shadow') hs.textShadow=`3px 3px 0 ${t.accent}`;
  if(t.effect==='inset-shadow') hs.textShadow=`0 1px 1px ${t.accent}90, 0 1px 2px rgba(0,0,0,0.2)`;
  if(t.effect==='subtle-glow') hs.textShadow=`0 0 12px ${t.accent}30`;
  if(t.effect==='soft-glow') hs.textShadow=`0 0 10px ${t.accent}40, 0 0 26px ${t.accent}60`;
  if(t.effect==='letterpress') hs.textShadow='0 1px 0 rgba(255,255,255,0.2)';
  if(t.effect==='shine') hs.textShadow=`0 0 16px ${t.accent}80`;
  if(t.effect==='neon-glow') hs.textShadow=`0 0 5px ${t.fg}80, 0 0 10px ${t.fg}80, 0 0 15px ${t.accent}c0, 0 0 20px ${t.accent}c0`;
  if(t.effect==='soft') hs.textShadow='0 2px 4px rgba(0,0,0,0.15)';
  if(t.effect==='none') hs.textShadow = 'none';

  els.themeSelect.value = i;
  const newFgHex = rgbToHex(getComputedStyle(els.poster).color);
  els.fgPicker.value = newFgHex;
  els.fgHex.textContent = newFgHex;
  
  // v10.1: Fix for solid color backgrounds
  let fallbackBg;
  if (t.bg.includes('linear-gradient')) {
    // It's a gradient, grab the second color as a fallback
    const parts = t.bg.split(',');
    if (parts[1]) {
        fallbackBg = parts[1].trim();
    } else {
        fallbackBg = '#000000'; // Should not happen, but safe
    }
  } else {
    // It's a solid color
    fallbackBg = t.bg;
  }
  
  if (fallbackBg.startsWith('#')) {
    els.bgPicker.value = fallbackBg;
    els.bgHex.textContent = fallbackBg;
  }
  
  persist();
  requestAnimationFrame(autoFit); // Re-fit after font change
  requestAnimationFrame(updateContrastIndicator); // v9: Update contrast
  positionWatermark(); // v9: Update watermark opacity
}

function applyAlign(a){
  state.align = a;
  els.alignBtns.forEach(b=>{
    const on = b.dataset.align===a;
    b.classList.toggle('active',on); b.setAttribute('aria-pressed',on)
  });
  const flex = {left:'flex-start',center:'center',right:'flex-end'}[a];
  els.content.style.alignItems = flex;
  els.poster.style.textAlign = a;
  persist();
}
function applyAuthorPos(p){
  state.authorPos = p;
  els.authorPosBtns.forEach(b=>{
    const on = b.dataset.pos===p;
    b.classList.toggle('active',on); b.setAttribute('aria-pressed',on)
  });
  els.content.style.flexDirection = (p === 'top') ? 'column-reverse' : 'column';
  persist();
  autoFit(); // Refit as author position changes available space
}

// function applyPad(){ document.documentElement.style.setProperty('--pad', state.pad + 'px'); positionWatermark(); autoFit(); persist(); } // v10: Removed
function applyRatio(r){
  const map={'1:1':100,'4:5':125,'9:16':177.78,'16:9':56.25};
  els.ratioSpacer.style.paddingTop = map[r] + '%';
  requestAnimationFrame(autoFit);
  persist();
}
function applyColors(){
  els.poster.style.color = els.fgPicker.value;
  els.poster.style.background = els.bgPicker.value;
  els.fgHex.textContent = els.fgPicker.value;
  els.bgHex.textContent = els.bgPicker.value;

  // When user picks a custom color, deselect theme and reset fonts
  els.themeSelect.value = "";
  state.theme = ""; // Set state theme to custom
  
  // v12: Update default custom font
  const hs = els.headline.style;
  hs.fontFamily = "'Inter', sans-serif";
  hs.fontWeight = "600";
  hs.fontStyle = "normal";
  hs.textTransform = "none";
  hs.letterSpacing = "0.1px";
  hs.textShadow = "none";
  hs.lineHeight = "1.15"; // Reset line height
  
  const as = els.author.style;
  as.fontFamily = "'Inter', sans-serif";
  as.fontWeight = "400";
  // as.fontSize = "28px"; // v11: This is now controlled by the slider
  as.fontStyle = "normal";
  as.textTransform = "none";
  as.letterSpacing = "normal";

  // Reset sliders to default
  els.lineHeightInput.value = 1.15;
  state.lineHeight = 1.15;
  els.citationSizeInput.value = 28; /* v10: Was 24 */
  state.citationSize = 28; /* v10: Was 24 */

  persist();
  requestAnimationFrame(updateContrastIndicator); // v9: Update contrast
  positionWatermark(); // v9: Update watermark opacity
}

/* ------ Watermark ------ */
function handleLogoUpload(event) {
  const file = event.target.files[0];
  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      state.logoDataBase64 = e.target.result;
      els.wmarkLogo.src = state.logoDataBase64;
      // updateContentPadding(); // v10.1: Removed
      positionWatermark(); // Re-position
      autoFit(); // v10.1: Recalculate layout
      persist();
      say('Logo added');
    };
    reader.readAsDataURL(file);
  } else if (file) {
    say('Please select an image file');
  }
  els.logoUpload.value = null; // Reset file input
}

function clearLogo() {
  state.logoDataBase64 = null;
  els.wmarkLogo.src = '';
  // updateContentPadding(); // v10.1: Removed
  positionWatermark(); // Re-position
  autoFit(); // v10.1: Recalculate layout
  persist();
  say('Logo cleared');
}

function setWmPos(pos){
  state.wmPos = pos;
  els.wmChoices.forEach(b=>{
    const on = b.dataset.pos===pos;
    b.classList.toggle('active', on);
    b.setAttribute('aria-pressed', on);
  });
  positionWatermark(); persist();
}
function positionWatermark(){
  const pad = getComputedStyle(document.documentElement).getPropertyValue('--pad').trim();
  const wmarkEl = state.logoDataBase64 ? els.wmarkLogo : els.wmark;
  const otherEl = state.logoDataBase64 ? els.wmark : els.wmarkLogo;

  wmarkEl.classList.toggle('hidden', !els.wmToggle.checked);
  otherEl.classList.add('hidden');
  
  // --- v9: Smart Opacity ---
  try {
    const bgRgb = parseColor(els.bgPicker.value);
    const bgL = getLuminance(bgRgb);
    let newOpacity = 0.65; // Default
    if (bgL > 0.5) { // Bright background
        newOpacity = 0.45;
    } else if (bgL < 0.1) { // Dark background
        newOpacity = 0.85;
    }
    wmarkEl.style.opacity = newOpacity;
    if (state.logoDataBase64) {
       els.wmarkLogo.style.opacity = newOpacity; // Ensure logo opacity is also set
    }
  } catch (e) {
    wmarkEl.style.opacity = 0.65; // Fallback
  }
  // --- v9: END Smart Opacity ---

  const style = wmarkEl.style;
  style.top = 'auto'; style.left='auto'; style.right='auto'; style.bottom='var(--pad)';
  style.transform = 'none';
  
  if(state.wmPos==='bl'){ style.left = pad; }
  if(state.wmPos==='bc'){ style.left = '50%'; style.transform='translateX(-50%)'; }
  if(state.wmPos==='br'){ style.right = pad; }
}

/* ------ v10.1: Watermark Overlap Fix ------ */
// function updateContentPadding() { ... } // v10.1: Removed

/* ------ Auto-fit (Polished) ------ */
function autoFit(){
  if (els.poster.clientHeight === 0) {
    requestAnimationFrame(autoFit);
    return;
  }
  
  const H = els.poster.clientHeight, pad = parseFloat(getComputedStyle(els.poster).paddingTop);
  const authorH = els.author.offsetHeight||20;

  // v10.1: Refactored calculation
  const available = H - (pad * 2) - authorH - 50 - 20; // pad, authorH, content-padding-bottom(50), buffer(20)

  let min = 24, max = 160, mid;
  let guard = 20; // Safety guard
  
  // Hide headline to prevent layout thrashing
  els.headline.style.visibility = 'hidden';
  
  while (max - min > 1 && guard--) {
    mid = Math.floor((min + max) / 2);
    els.headline.style.fontSize = mid + 'px';
    if (els.headline.scrollHeight > available) {
      max = mid;
    } else {
      min = mid;
    }
  }
  
  // Show headline and set final size
  els.headline.style.fontSize = min + 'px';
  els.headline.style.visibility = 'visible';

  // Update slider
  els.sizeInput.value = min;
  state.size = min; // Also update state

  // v10: Ensure citation is smaller than headline
  if (state.citationSize >= min) {
      const newCitationSize = Math.max(10, min - 1); // Ensure it doesn't go below min
      state.citationSize = newCitationSize;
      els.citationSizeInput.value = newCitationSize;
      els.author.style.fontSize = newCitationSize + 'px';
  }
}


/* ------ Persistence ------ */
const KEY='quotesn_pro_post_v9'; // v9: Updated key
function persist(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
function restore(){
  try{
    const s = JSON.parse(localStorage.getItem(KEY)||'{}');
    const defaults = {
        citationSize: 28, // v10: Increased from 24
        lineHeight: 1.15,
        authorPos: 'bottom',
        logoDataBase64: null,
        quote: s.quote || DEFAULTS.quote,
        author: s.author || DEFAULTS.author,
        wmText: s.wmText || DEFAULTS.wmText,
        exportRes: s.exportRes || DEFAULTS.exportRes, // v9
    };
    Object.assign(state, DEFAULTS, s, defaults);
  }catch(e){
    Object.assign(state, DEFAULTS);
  }
}

/* ------ Export ------ */
async function exportImg(type='png'){
  try{
    // v13: New render-wait logic
    say('Rendering…');

    // 1. Wait for all fonts to be loaded
    await document.fonts.ready;

    // 2. Wait for logo to be loaded (if it exists)
    els.wmark.style.fontFamily = "'Inter', sans-serif";
    if (state.logoDataBase64 && els.wmarkLogo.src) {
        await new Promise((resolve, reject) => {
            if (els.wmarkLogo.complete && els.wmarkLogo.naturalHeight !== 0) {
                resolve();
            } else {
                els.wmarkLogo.onload = resolve;
                els.wmarkLogo.onerror = reject;
            }
        });
    }

    // 3. Force browser to re-calculate styles with loaded fonts
    window.scrollTo(0, 0);
    getComputedStyle(els.headline).fontSize; // Force style recalc
    getComputedStyle(els.author).fontSize; // Force style recalc

    // 4. Wait for the next animation frame
    await new Promise(r => requestAnimationFrame(r));

    // 5. Wait a brief moment for the browser to paint the new fonts
    await new Promise(r => setTimeout(r, 250)); 

    // 6. Now, finally, render the canvas
    const targetMap = { standard: 1080, hd: 2160, '4k': 4320 };
    // v13: (Rest of function continues from here)
    const targetWidth = targetMap[state.exportRes] || 1080;
    const currentWidth = els.poster.offsetWidth;
    const scale = targetWidth / currentWidth;
    
    const canvas = await html2canvas(els.poster,{
      backgroundColor: (type==='png'?'transparent':null),
      scale,
      useCORS:true,
      logging: false
    });
    
    const mime = type==='jpeg'?'image/jpeg':(type==='webp'?'image/webp':'image/png');
    const url = canvas.toDataURL(mime, 0.98);
    const a=document.createElement('a');
    
    // v9: Updated file naming logic
    const date=new Date().toISOString().slice(0,10);
    const themeName = (els.themeSelect.value !== "") ? THEMES[state.theme].name.replace(/\s+/g,'_') : "Custom";
    
    let downloadName;
    if (state.exportRes === 'standard') {
        downloadName = `${date}_1x-${themeName}`;
    } else if (state.exportRes === 'hd') {
        downloadName = `${date}_HD-${themeName}`; // Modified blueprint for clarity
    } else if (state.exportRes === '4k') {
        downloadName = `${date}_4K-${themeName}`; // Modified blueprint for clarity
    } else {
        downloadName = `${date}_1x-${themeName}`; // Fallback
    }
    a.href=url; a.download=`${downloadName}.${type==='jpeg'?'jpg':type}`;
    
    a.click();
    await new Promise(r => setTimeout(r, 0)); // v9: Stability fix
    say('Downloaded ✔');
  }catch(e){ console.error("Export failed:", e); say('Export failed'); }
}

/* ------ Share ------ */
async function shareImg(){
  try{
    // v13: New render-wait logic
    say('Preparing share…');

    // 1. Wait for all fonts to be loaded
    await document.fonts.ready;

    // 2. Wait for logo to be loaded (if it exists)
    els.wmark.style.fontFamily = "'Inter', sans-serif";
    if (state.logoDataBase64 && els.wmarkLogo.src) {
        await new Promise((resolve, reject) => {
            if (els.wmarkLogo.complete && els.wmarkLogo.naturalHeight !== 0) {
                resolve();
            } else {
                els.wmarkLogo.onload = resolve;
                els.wmarkLogo.onerror = reject;
            }
        });
    }

    // 3. Force browser to re-calculate styles with loaded fonts
    window.scrollTo(0, 0);
    getComputedStyle(els.headline).fontSize; // Force style recalc
    getComputedStyle(els.author).fontSize; // Force style recalc

    // 4. Wait for the next animation frame
    await new Promise(r => requestAnimationFrame(r));

    // 5. Wait a brief moment for the browser to paint the new fonts
    await new Promise(r => setTimeout(r, 250)); 

    // 6. Now, finally, render the canvas
    const targetMap = { standard: 1080, hd: 2160, '4k': 4320 };
    // v13: (Rest of function continues from here)
    const targetWidth = targetMap[state.exportRes] || 1080;
    const currentWidth = els.poster.offsetWidth;
    const scale = targetWidth / currentWidth;

    const canvas = await html2canvas(els.poster,{
      backgroundColor:null,
      scale,
      useCORS:true,
      logging: false
    });
    const blob = await new Promise(res=>canvas.toBlob(res,'image/png',0.95));
    const file = new File([blob],'quote.png',{type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'Quote Poster',text:'Made with Quotesn'});
    }else{
      exportImg('png');
    }
  }catch(e){ console.error("Share failed:", e); say('Share not supported'); }
}

// NEW: Function to reset all settings to default
function applyDefaults() {
  Object.assign(state, DEFAULTS);
  
  try { localStorage.removeItem(KEY); } catch(e) {}
  
  els.quoteInput.value = DEFAULTS.quote;
  els.authorInput.value = DEFAULTS.author;
  els.wmText.value = DEFAULTS.wmText;
  els.wmToggle.checked = DEFAULTS.wmToggle;
  els.exportRes.value = DEFAULTS.exportRes; // v9

  clearLogo(); // v10.1: This will also call autoFit
  
  applyTheme(DEFAULTS.theme);
  applyAlign(DEFAULTS.align);
  applyAuthorPos(DEFAULTS.authorPos);
  
  // els.padInput.value = DEFAULTS.pad; // v10: Removed
  // applyPad(); // v10: Removed
  
  els.ratioSelect.value = DEFAULTS.ratio;
  applyRatio(DEFAULTS.ratio);
  
  els.sizeInput.value = DEFAULTS.size;
  
  setWmPos(DEFAULTS.wmPos);
  positionWatermark(); 
  
  els.quoteInput.dispatchEvent(new Event('input'));
  
  say('New post created');
}

/* ------ Events ------ */
els.quoteInput.addEventListener('input',()=>{
  els.headline.textContent = els.quoteInput.value;
  state.quote = els.quoteInput.value;
  const rtl = isRTL(els.quoteInput.value);
  els.headline.dir = rtl ? 'rtl' : 'ltr';
  els.author.dir = rtl ? 'rtl' : 'ltr';
  autoFit();
  persist();
});
els.authorInput.addEventListener('input',()=>{
  els.author.textContent = els.authorInput.value;
  state.author = els.authorInput.value;
  autoFit();
  persist();
});

els.newPostBtn.addEventListener('click', () => {
  setActiveIcon(els.newPostBtn);
  applyDefaults();
  say('New post created'); // v9
});

els.sizeInput.addEventListener('input',e=>{
  const newHeadlineSize = +e.target.value;
  state.size = newHeadlineSize;
  e.target.title = `Size: ${state.size}px`; // v9: Tooltip
  
  // v10: Ensure citation is smaller than headline
  if (state.citationSize >= newHeadlineSize) {
      const newCitationSize = Math.max(10, newHeadlineSize - 1);
      state.citationSize = newCitationSize;
      els.citationSizeInput.value = newCitationSize;
      els.author.style.fontSize = newCitationSize + 'px';
  }

  persist();
  autoFit();
});
// els.padInput.addEventListener('input',e=>{ ... }); // v10: Removed

els.citationSizeInput.addEventListener('input',e=>{
  let newCitationSize = +e.target.value;
  const currentHeadlineSize = state.size;

  // v10: Enforce citation is smaller than headline
  if (newCitationSize >= currentHeadlineSize) {
      newCitationSize = Math.max(10, currentHeadlineSize - 1);
      e.target.value = newCitationSize;
  }
  
  state.citationSize = newCitationSize;
  e.target.title = `Size: ${state.citationSize}px`; // v9: Tooltip
  els.author.style.fontSize = state.citationSize + 'px';
  els.themeSelect.value = "";
  state.theme = "";
  persist();
  autoFit(); // Recalculate layout
});
els.lineHeightInput.addEventListener('input',e=>{
  state.lineHeight=+e.target.value;
  e.target.title = `Height: ${state.lineHeight}`; // v9: Tooltip
  els.headline.style.lineHeight = state.lineHeight;
  els.themeSelect.value = "";
  state.theme = "";
  persist();
  autoFit();
});

els.alignBtns.forEach(b=>b.addEventListener('click',()=>{ applyAlign(b.dataset.align); }));
els.authorPosBtns.forEach(b=>b.addEventListener('click',()=>{ applyAuthorPos(b.dataset.pos); }));

els.autoFitBtn.addEventListener('click', () => { // v9: New
  autoFit();
  say('Auto-fit applied');
});
els.fixContrastBtn.addEventListener('click', fixContrast); // v9: New

els.themeSelect.addEventListener('change',e=>{
  if (e.target.value === "") {
    state.theme = "";
    persist();
    return;
  }
  applyTheme(+e.target.value);
});

els.toggleTheme.addEventListener('click', () => {
  setActiveIcon(els.toggleTheme);
  let nextIndex = 0;
  if (state.theme !== "") {
    nextIndex = (state.theme + 1) % THEMES.length;
  }
  applyTheme(nextIndex);
  const themeName = (els.themeSelect.value !== "") ? THEMES[state.theme].name : "Custom"; // v9
  say(`Theme → ${themeName}`); // v9
});
els.themeNextBtn.addEventListener('click',()=>{
  let nextIndex = 0;
  if (state.theme !== "") {
    nextIndex = (state.theme + 1) % THEMES.length;
  }
  applyTheme(nextIndex);
  const themeName = (els.themeSelect.value !== "") ? THEMES[state.theme].name : "Custom"; // v9
  say(`Theme → ${themeName}`); // v9
});

els.bgPicker.addEventListener('input', () => { applyColors(); }); // v9: applyColors handles contrast
els.fgPicker.addEventListener('input', () => { applyColors(); }); // v9: applyColors handles contrast

els.wmText.addEventListener('input',()=>{
  els.wmark.textContent = els.wmText.value;
  state.wmText = els.wmText.value;
  persist();
});
els.wmToggle.addEventListener('change',() => {
  state.wmToggle = els.wmToggle.checked;
  // updateContentPadding(); // v10.1: Removed
  positionWatermark();
  autoFit(); // v10.1: Recalculate layout
  persist();
});
els.wmChoices.forEach(btn=>btn.addEventListener('click',()=>setWmPos(btn.dataset.pos)));

els.logoUploadBtn.addEventListener('click', () => els.logoUpload.click());
els.logoClearBtn.addEventListener('click', clearLogo);
els.logoUpload.addEventListener('change', handleLogoUpload);

els.ratioSelect.addEventListener('change',e=>{ state.ratio=e.target.value; applyRatio(state.ratio); });
els.exportRes.addEventListener('change',() => { // v9: New
  state.exportRes = els.exportRes.value;
  persist();
});


els.exportBtn.addEventListener('click', () => {
  setActiveIcon(els.exportBtn);
  els.exportMenu.classList.toggle('hidden');
});
// Main document click listener to close dropdowns
document.addEventListener('click',e=>{
  // Close header dropdown
  if(!els.exportBtn.contains(e.target) && !els.exportMenu.contains(e.target)) {
    els.exportMenu.classList.add('hidden');
  }
  // Close main download dropdown
  if(!els.downloadBtn.contains(e.target) && !els.exportMenu2.contains(e.target)) {
    els.exportMenu2.classList.add('hidden');
  }
});
els.exportMenu.addEventListener('click',e=>{ const t=e.target.dataset.type; if(t){ els.exportMenu.classList.add('hidden'); exportImg(t);} });
els.downloadBtn.addEventListener('click',()=>els.exportMenu2.classList.toggle('hidden'));
els.exportMenu2.addEventListener('click',e=>{ const t=e.target.dataset.type; if(t){ els.exportMenu2.classList.add('hidden'); exportImg(t);} });

els.shareBtn.addEventListener('click', () => {
  setActiveIcon(els.shareBtn);
  shareImg();
});
window.addEventListener('resize',()=>requestAnimationFrame(autoFit));

/* Keyboard shortcuts */
document.addEventListener('keydown',e=>{
  if (e.target.matches('input,textarea')) return;
  if (e.key==='t' || e.key==='T'){ els.themeNextBtn.click(); } // Change main button
  if (e.key==='d' || e.key==='D'){ exportImg('png'); }
  if (e.key==='s' || e.key==='S'){ shareImg(); }
  if (e.key==='a' || e.key==='A'){ els.autoFitBtn.click(); } // v9
  if (e.key==='r' || e.key==='R'){ els.newPostBtn.click(); } // v9
});

/* Build theme UI */
function buildThemeUI(){
  els.themeSelect.innerHTML = `<option value="">-- Custom --</option>` + THEMES.map((t,i)=>`<option value="${i}">${t.name}</option>`).join('');
  els.themeGrid.innerHTML='';
  THEMES.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='swatch w-full'; b.style.background=t.bg; b.title=t.name;
    b.addEventListener('click',()=>{ applyTheme(i); });
    els.themeGrid.appendChild(b);
  });
}

/* Init */
(function init(){
  restore(); // load previous state into 'state' object
  buildThemeUI();
  
  // Apply restored state
  if (state.theme === "" || isNaN(state.theme) || state.theme === null) {
      // Apply custom restored values
      els.citationSizeInput.value = state.citationSize;
      els.author.style.fontSize = state.citationSize + 'px';
      els.lineHeightInput.value = state.lineHeight;
      els.headline.style.lineHeight = state.lineHeight;
      
      // Check for valid stored colors, fallback to defaults if invalid
      const validFg = state.fg && state.fg.startsWith('#') ? state.fg : DEFAULTS.fg;
      const validBg = state.bg && state.bg.startsWith('#') ? state.bg : '#0b1020';
      
      els.fgPicker.value = validFg;
      els.bgPicker.value = validBg;

      els.poster.style.color = validFg;
      els.poster.style.background = validBg;
      els.fgHex.textContent = validFg;
      els.bgHex.textContent = validBg;
      
      // Reset fonts to default since it's a custom theme
      // v12: Updated default custom font
      els.headline.style.fontFamily = "'Inter', sans-serif";
      els.headline.style.fontWeight = "600";
      els.author.style.fontFamily = "'Inter', sans-serif";
      
      els.themeSelect.value = "";
  } else {
      // Apply theme
      applyTheme(state.theme);
  }
  
  if (state.logoDataBase64) {
    els.wmarkLogo.src = state.logoDataBase64;
  }
  
  // updateContentPadding(); // v10.1: Removed
  
  applyAlign(state.align);
  applyAuthorPos(state.authorPos);
  
  // els.padInput.value = state.pad; // v10: Removed
  // applyPad(); // v10: Removed
  document.documentElement.style.setProperty('--pad', '60px'); // v10: Set default on init
  
  els.ratioSelect.value = state.ratio;
  applyRatio(state.ratio);
  
  els.sizeInput.value = state.size;
  // v11: Apply citation size from state on init
  els.citationSizeInput.value = state.citationSize;
  els.author.style.fontSize = state.citationSize + 'px';
  
  setWmPos(state.wmPos);
  
  els.quoteInput.value = state.quote;
  els.authorInput.value = state.author;
  els.wmText.value = state.wmText;
  els.wmToggle.checked = state.wmToggle;
  els.exportRes.value = state.exportRes; // v9
  
  els.wmark.textContent = els.wmText.value;
  positionWatermark();
  els.quoteInput.dispatchEvent(new Event('input'));
  
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => {
        // updateContentPadding(); // v10.1: Removed
        requestAnimationFrame(autoFit);
        setTimeout(() => els.poster.classList.add('loaded'), 50); // v9: Add loaded class
    });
  } else {
    setTimeout(() => {
        // updateContentPadding(); // v10.1: Removed
        requestAnimationFrame(autoFit);
        els.poster.classList.add('loaded'); // v9: Add loaded class
    }, 500); // Fallback
  }
  
  updateContrastIndicator(); // v9: Initial check
  say('Ready ✨');
})();
</script>
</body>
</html>
