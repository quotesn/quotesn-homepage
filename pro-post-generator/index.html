<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pro Post Generator — Quotesn Studio</title>

<!-- Canonical + SEO --><link rel="canonical" href="https://www.quotesn.com/pro-post-generator"/>
<meta name="title" content="Pro Post Generator — Create Shareable Quote Posters Instantly">
<meta name="description" content="Design, customize, and export high-quality quote posters with curated themes, neon glow, and transparent rounded PNGs.">

<!-- Open Graph --><meta property="og:type" content="website">
<meta property="og:title" content="Pro Post Generator — Quotesn Studio">
<meta property="og:description" content="Create beautiful quote posters. Themes, watermark, retina export, and more.">
<meta property="og:url" content="https://www.quotesn.com/pro-post-generator">
<meta property="og:image" content="https://www.quotesn.com/assets/og-pro-post.png">

<!-- Twitter --><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Pro Post Generator — Quotesn Studio">
<meta name="twitter:description" content="Create beautiful quote posters. Themes, watermark, retina export, and more.">
<meta name="twitter:image" content="https://www.quotesn.com/assets/og-pro-post.png">

<!-- JSON-LD --><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Pro Post Generator — Quotesn Studio",
  "applicationCategory": "DesignApplication",
  "operatingSystem": "Web",
  "url": "https://www.quotesn.com/pro-post-generator",
  "description": "Create export-accurate quote posters with curated themes, watermark, and retina PNG/JPG/WEBP.",
  "publisher": { "@type": "Organization", "name": "Quotesn" }
}
</script>

<!-- Favicon --><link rel="icon" href="https://www.quotesn.com/favicon.ico" type="image/x-icon"/>

<!-- Tailwind + html2canvas --><script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Google Fonts (subset of families to keep size lean) --><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Playfair+Display:wght@400;600&family=Lora:wght@400;600&family=Poppins:wght@400;600&family=Montserrat:wght@400;600&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<style>
:root{
  --panel-bg:#fff;--panel-border:#e5e7eb;--muted:#64748b;
  --pad:56px;--poster-max:860px;
}
html,body{height:100%}
body{font-family:Inter,ui-sans-serif,system-ui;color:#0f172a;background:linear-gradient(180deg,#f6f8fb,#eef2f7)}

/* Header */
.studio{background:#ffffffe6;backdrop-filter:blur(10px);border-bottom:1px solid var(--panel-border);box-shadow:0 4px 18px rgba(0,0,0,.06)}
.icon-purple{color:#4f46e5}

/* Panels */
.panel{background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
.field{border:1px solid var(--panel-border);background:#fff;border-radius:10px}
.subtle{color:var(--muted)}
.swatch{height:56px;border-radius:12px;border:1px solid #e5e7eb}

/* Poster & canvas */
.ratio-box{position:relative;width:100%;max-width:var(--poster-max);margin:0 auto}
.ratio-spacer{width:100%}
.abs{position:absolute;inset:0}
#poster{position:absolute;inset:0;border-radius:32px;padding:var(--pad);display:flex;align-items:center;justify-content:center;text-align:center;box-shadow:0 22px 80px rgba(15,23,42,.12);overflow:hidden}
#content{width:100%;display:flex;flex-direction:column;align-items:center}
#headline{font-family:"DM Serif Display",serif;font-weight:400;line-height:1.15;letter-spacing:.1px;margin:0 0 1rem}
#author{font-size:18px;opacity:.9;margin:0}
#wmark{position:absolute;font-size:14px;opacity:.65;pointer-events:none;bottom:var(--pad);right:var(--pad)}
.align.active{outline:2px solid #6366f1;outline-offset:2px}

/* Secondary action buttons */
.btn-action{display:flex;align-items:center;justify-content:center;gap:.6rem;font-weight:600;border-radius:14px;padding:.7rem 1.1rem;border:1px solid #e5e7eb;transition:all .2s ease}
.btn-action:hover{background:#eef2ff;box-shadow:0 6px 20px rgba(99,102,241,.22)}
.btn-action svg{width:18px;height:18px}

/* Neon glow toggle (applied to headline only) */
.glow #headline{text-shadow:0 0 0 rgba(0,0,0,0), 0 0 10px rgba(236,72,153,.25), 0 0 26px rgba(79,70,229,.35)}
/* Focus ring */
:focus-visible{outline:3px solid #6366f1;outline-offset:2px}


/* ======= UI POLISH PATCH v3.6 (Applied) ======= */

/* --- Header icons refinement --- */
.icon-btn {
  position: relative;
  display:flex;align-items:center;justify-content:center;
  width:44px;height:44px;border-radius:14px;
  border:1px solid var(--panel-border);background:#fff;
  transition:all .2s ease;
  box-shadow:0 0 0 rgba(79,70,229,0);
}
.icon-btn:hover {
  transform:translateY(-1px) scale(1.05);
  box-shadow:0 0 12px rgba(79,70,229,.25);
}
.icon-btn.active {
  background:linear-gradient(135deg,#eef2ff,#e0e7ff);
  box-shadow:0 0 16px rgba(79,70,229,.35);
}
.icon-btn svg {
  width:22px;height:22px;stroke-width:2;transition:transform .2s;
}
.icon-btn:hover svg { transform:scale(1.07); }

/* --- Dropdown visibility & layering --- */
#exportMenu, #exportMenu2 {
  z-index: 60; /* ensure always above panels */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(15,23,42,.15);
  animation:fadeIn .15s ease-out;
}
@keyframes fadeIn {from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:none;}}

/* --- Watermark position buttons --- */
.wm-choices {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:.75rem;
}
.wm-choices button {
  border:1px solid #e2e8f0;
  border-radius:14px;
  background:#fff;
  padding:.7rem .9rem;
  transition:all .18s ease;
  display:flex;align-items:center;justify-content:center;
}
.wm-choices button:hover {
  box-shadow:0 4px 10px rgba(99,102,241,.15);
  border-color:#c7d2fe;
}
.wm-choices button.active {
  border-color:#4f46e5;
  background:#eef2ff;
  box-shadow:0 0 0 2px #4f46e5 inset;
}
.wm-choices .dot {
  width:8px;height:8px;border-radius:9999px;
  background:#6366f1;
  opacity:.6;transition:opacity .2s;
}
.wm-choices .bar{ /* This style was in the original, retained for inner layout */
  display:flex;align-items:center;justify-content:space-between;gap:.75rem;
  background:transparent; /* bg moves to parent */
  border-radius:10px;
  padding:0; /* padding moves to parent */
  border:0; /* border moves to parent */
  width:64px;
}
/* === FIX: This rule now correctly targets ONLY the active dot === */
.wm-choices button.active .dot:not(.opacity-30) {
  opacity: 1;
}

/* --- Optional visual accent --- */
.icon-btn.active::after {
  content:"";
  position:absolute;inset:-4px;border-radius:16px;
  background:radial-gradient(ellipse at center,rgba(99,102,241,.15),transparent 60%);
  z-index:-1;
}
/* ======= END OF PATCH ======= */

</style>
</head>
<body>
<!-- Header --><header class="studio sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="https://www.quotesn.com/assets/logo-placeholder.png" alt="Quotesn Logo" class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 via-violet-500 to-fuchsia-500" loading="lazy"/>
      <span class="font-semibold text-[15px]">Pro Post Generator</span>
    </div>
    <div class="flex items-center gap-3">
      <!-- Sparkle Shuffle = Next Theme (T) --><button id="toggleTheme" class="icon-btn" aria-label="Change Theme (T)" title="Change Theme (T)">
        <svg class="icon-purple" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 4.5l.6 2.1a4 4 0 0 0 2.3 2.7L12 10l-1.6.7a4 4 0 0 0-2.3 2.7L7.5 15.5l-.6-2.1a4 4 0 0 0-2.7-2.3L2 10l2.2-.6a4 4 0 0 0 2.7-2.7L7.5 4.5Z"/>
          <path stroke-linecap="round" d="M16.5 3.5l.3 1.2a3 3 0 0 0 2 2l1.2.3-1.2.3a3 3 0 0 0-2 2l-.3 1.2-.3-1.2a3 3 0 0 0-2-2l-1.2-.3 1.2-.3a3 3 0 0 0 2-2l.3-1.2Z"/>
        </svg>
      </button>

      <!-- Download menu (D) --><div class="relative">
        <button id="exportBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" aria-controls="exportMenu" aria-label="Download (D)" title="Download (D)">
          <svg class="icon-purple" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v9m0 0-3-3m3 3 3-3M5 18.5h14" />
          </svg>
        </button>
        <div id="exportMenu" class="hidden absolute right-0 mt-2 w-44 panel p-2" role="menu">
          <button data-type="png" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">PNG (transparent)</button>
          <button data-type="jpeg" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">JPG (solid)</button>
          <button data-type="webp" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">WEBP</button>
        </div>
      </div>

      <!-- Share (S) - Corrected Icon --><button id="shareBtn" class="icon-btn" aria-label="Share (S)" title="Share (S)">
        <svg class="icon-purple" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="18" cy="5" r="3"></circle>
          <circle cx="6" cy="12" r="3"></circle>
          <circle cx="18" cy="19" r="3"></circle>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Panels --><section class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 p-4">

  <!-- Content --><div class="panel p-5">
    <h3 class="font-semibold mb-3">Content</h3>
    <label class="block mb-3">
      <span class="subtle text-sm mb-1 block">Quote</span>
      <textarea id="quoteInput" rows="3" class="field w-full px-3 py-2" aria-label="Quote">Stay focused. Ship value. Repeat.</textarea>
    </label>
    <label class="block">
      <span class="subtle text-sm mb-1 block">Author</span>
      <input id="authorInput" type="text" class="field w-full px-3 py-2" value="— Quotesn" aria-label="Author"/>
    </label>
  </div>

  <!-- Typography & Layout --><div class="panel p-5">
    <h3 class="font-semibold mb-3">Typography & Layout</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <label>
        <span class="subtle text-sm mb-1 block">Font Family</span>
        <select id="fontFamily" class="field w-full px-3 py-2" aria-label="Font Family">
          <option value="DM Serif Display, serif">DM Serif Display</option>
          <option value="Playfair Display, serif">Playfair Display</option>
          <option value="Lora, serif">Lora</option>
          <option value="Poppins, sans-serif">Poppins</option>
          <option value="Montserrat, sans-serif">Montserrat</option>
          <option value="Inter, sans-serif">Inter</option>
        </select>
      </label>
      <label>
        <span class="subtle text-sm mb-1 block">Headline Size</span>
        <input id="sizeInput" type="range" min="24" max="140" value="56" class="w-full" aria-label="Headline Size"/>
      </label>
      <label>
        <span class="subtle text-sm mb-1 block">Padding</span>
        <input id="padInput" type="range" min="24" max="140" value="56" class="w-full" aria-label="Canvas Padding"/>
      </label>
      <div>
        <span class="subtle text-sm mb-1 block">Alignment</span>
        <div class="flex gap-2">
          <button class="align icon-btn" data-align="left" title="Align Left" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h12M4 12h16M4 18h12" stroke-linecap="round"/></svg>
          </button>
          <button class="align icon-btn" data-align="center" title="Align Center" aria-pressed="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 6h12M4 12h16M6 18h12" stroke-linecap="round"/></svg>
          </button>
          <button class="align icon-btn" data-align="right" title="Align Right" aria-pressed="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 6h12M4 12h16M8 18h12" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
      <label>
        <span class="subtle text-sm mb-1 block">Aspect Ratio</span>
        <select id="ratioSelect" class="field w-full px-3 py-2" aria-label="Aspect Ratio">
          <option value="1:1">Square 1 : 1</option>
          <option value="4:5" selected>Portrait 4 : 5</option>
          <option value="9:16">Story 9 : 16</option>
          <option value="16:9">Landscape 16 : 9</option>
        </select>
      </label>
      <label>
        <span class="subtle text-sm mb-1 block">Text Color</span>
        <input id="fgPicker" type="color" class="field w-full px-1 py-2" value="#ffffff" aria-label="Text Color"/>
      </label>
      <label>
        <span class="subtle text-sm mb-1 block">Background Color</span>
        <input id="bgPicker" type="color" class="field w-full px-1 py-2" value="#0b1020" aria-label="Background Color"/>
      </label>
    </div>

    <label class="flex items-center gap-2 mt-5">
      <input id="shadowToggle" type="checkbox" class="accent-indigo-600" aria-label="Neon Glow"/>
      <span class="subtle text-sm">Auto Shadow Glow / Neon Effect</span>
    </label>
  </div>

  <!-- Themes & Watermark --><div class="panel p-5">
    <h3 class="font-semibold mb-3">Themes & Watermark</h3>

    <label class="block mb-3">
      <span class="subtle text-sm mb-1 block">Theme</span>
      <select id="themeSelect" class="field w-full px-3 py-2" aria-label="Theme"></select>
    </label>

    <div id="themeGrid" class="grid grid-cols-3 gap-3 mb-4" aria-label="Theme Grid"></div>

    <div class="grid gap-3">
      <label>
        <span class="subtle text-sm mb-1 block">Watermark Text</span>
        <input id="wmText" type="text" class="field w-full px-3 py-2" value="quotesn.com" aria-label="Watermark Text"/>
      </label>

      <div>
        <span class="subtle text-sm mb-1 block">Watermark Position (Bottom)</span>
        <div class="wm-choices" role="group" aria-label="Watermark Position">
          <button class="wm-pos" data-pos="bl" aria-pressed="false">
            <div class="bar">
              <span class="dot"></span>
              <span class="dot opacity-30"></span>
              <span class="dot opacity-30"></span>
            </div>
          </button>
          <button class="wm-pos" data-pos="bc" aria-pressed="false">
            <div class="bar">
              <span class="dot opacity-30"></span>
              <span class="dot"></span>
              <span class="dot opacity-30"></span>
            </div>
          </button>
          <button class="wm-pos active" data-pos="br" aria-pressed="true">
            <div class="bar">
              <span class="dot opacity-30"></span>
              <span class="dot opacity-30"></span>
              <span class="dot"></span>
            </div>
          </button>
        </div>
      </div>

      <label class="flex items-center gap-2">
        <input id="wmToggle" type="checkbox" class="accent-indigo-600" checked aria-label="Show Watermark"/>
        <span class="subtle text-sm">Show Watermark</span>
      </label>

      <label class="flex items-center gap-2">
        <input id="retinaToggle" type="checkbox" class="accent-indigo-600" checked aria-label="Retina 2x"/>
        <span class="subtle text-sm">Retina 2× Export</span>
      </label>
    </div>

    <!-- Secondary Action Buttons --><div class="flex flex-col sm:flex-row gap-3 mt-6">
      <button id="themeNextBtn" class="btn-action flex-1 text-indigo-700" aria-label="Change Theme">
        <svg class="text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.5 4.5l.6 2.1a4 4 0 0 0 2.3 2.7L12 10l-1.6.7a4 4 0 0 0-2.3 2.7L7.5 15.5l-.6-2.1a4 4 0 0 0-2.7-2.3L2 10l2.2-.6a4 4 0 0 0 2.7-2.7L7.5 4.5Z"/></svg>
        Change Theme
      </button>
      <div class="relative flex-1">
        <button id="downloadBtn" class="btn-action w-full bg-indigo-600 text-white hover:bg-indigo-700" aria-haspopup="menu" aria-expanded="false" aria-controls="exportMenu2" aria-label="Download">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v9m0 0-3-3m3 3 3-3M5 18.5h14"/></svg>
          Download Image
        </button>
        <div id="exportMenu2" class="hidden absolute left-0 mt-2 w-full panel p-2" role="menu">
          <button data-type="png" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">PNG (transparent)</button>
          <button data-type="jpeg" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">JPG (solid)</button>
          <button data-type="webp" class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-50" role="menuitem">WEBP</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Poster --><main class="max-w-7xl mx-auto px-4 pb-16">
  <div class="ratio-box">
    <div id="ratioSpacer" class="ratio-spacer" style="padding-top:125%"></div>
    <div class="abs">
      <div id="poster" style="background:linear-gradient(135deg,#22d3ee,#6366f1 60%,#a855f7);color:#fff;">
        <div id="content">
          <h1 id="headline" style="font-size:56px;">Stay focused. Ship value. Repeat.</h1>
          <p id="author">— Quotesn</p>
        </div>
        <div id="wmark">quotesn.com</div>
      </div>
    </div>
  </div>
  <p id="status" class="text-center text-sm text-indigo-600 mt-4 h-6" aria-live="polite"></p>
</main>

<footer class="text-center text-xs text-slate-500 pb-10">© <span id="yy"></span> Quotesn • <a class="underline" href="https://www.quotesn.com">quotesn.com</a></footer>

<script>
const $ = id => document.getElementById(id);

/* ------ Elements ------ */
const els = {
  quoteInput: $('quoteInput'), authorInput: $('authorInput'),
  fontFamily: $('fontFamily'), sizeInput: $('sizeInput'), padInput: $('padInput'),
  alignBtns: document.querySelectorAll('.align'),
  ratioSelect: $('ratioSelect'), fgPicker: $('fgPicker'), bgPicker: $('bgPicker'),
  shadowToggle: $('shadowToggle'),
  themeSelect: $('themeSelect'), themeGrid: $('themeGrid'),
  wmText: $('wmText'), wmToggle: $('wmToggle'),
  wmChoices: document.querySelectorAll('.wm-pos'),
  retinaToggle: $('retinaToggle'),
  themeNextBtn: $('themeNextBtn'),
  ratioSpacer: $('ratioSpacer'), poster: $('poster'),
  content: $('content'), headline: $('headline'), author: $('author'),
  wmark: $('wmark'),
  toggleTheme: $('toggleTheme'), exportBtn: $('exportBtn'), exportMenu: $('exportMenu'),
  downloadBtn: $('downloadBtn'), exportMenu2: $('exportMenu2'),
  shareBtn: $('shareBtn'),
  status: $('status')
};

document.getElementById('yy').textContent = new Date().getFullYear();

/* ------ Themes v3 (Updated) ------ */
const THEMES = [
  {name:"Neon Pulse",bg:"linear-gradient(135deg,#0f0c29,#302b63,#24243e)",fg:"#f8fafc",accent:"#00ffff"},
  {name:"Sunrise Bloom",bg:"linear-gradient(135deg,#ff9a9e 0%,#fad0c4 99%)",fg:"#111827",accent:"#f43f5e"},
  {name:"Arctic Glass",bg:"linear-gradient(135deg,#a1c4fd 0%,#c2e9fb 100%)",fg:"#0f172a",accent:"#2563eb"},
  {name:"Desert Dusk",bg:"linear-gradient(135deg,#f6d365 0%,#fda085 100%)",fg:"#1e293b",accent:"#f97316"},
  {name:"Midnight Mint",bg:"linear-gradient(135deg,#28313b,#485461)",fg:"#ecfdf5",accent:"#10b981"},
  {name:"Royal Ink",bg:"linear-gradient(135deg,#141E30,#243B55)",fg:"#f5f3ff",accent:"#6366f1"},
  {name:"Rosewood",bg:"linear-gradient(135deg,#654ea3,#eaafc8)",fg:"#fdf2f8",accent:"#db2777"},
  {name:"Citrus Mist",bg:"linear-gradient(135deg,#fdfbfb 0%,#ebedee 100%)",fg:"#1f2937",accent:"#facc15"},
  {name:"Aurora Drift",bg:"linear-gradient(135deg,#0f2027,#203a43,#2c5364)",fg:"#e0f2fe",accent:"#38bdf8"}
];

let state = {
  theme: 0, align: 'center', size: 56, pad: 56, ratio: '4:5',
  shadow: false, wmPos: 'br'
};

/* ------ Helpers ------ */
const say = m => { els.status.textContent = m; clearTimeout(say._t); say._t = setTimeout(()=>els.status.textContent='',1800); };
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
function rgbToHex(rgb){const m=rgb.match(/\d+/g); if(!m) return '#000'; return '#'+m.slice(0,3).map(x=>(+x).toString(16).padStart(2,'0')).join('');}
function isRTL(text){return /[\u0590-\u05FF\u0600-\u06FF]/.test(text);} // Hebrew/Arabic ranges

/* --- Header icon active state toggle --- */
function setActiveIcon(btn) {
  document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  setTimeout(() => btn.classList.remove('active'), 800);
}

/* ------ Apply ------ */
function applyTheme(i){
  const t = THEMES[i];
  els.poster.style.background = t.bg;
  els.poster.style.color = t.fg;
  els.themeSelect.value = i;
  els.fgPicker.value = rgbToHex(getComputedStyle(els.poster).color);
  persist();
}
function applyAlign(a){
  state.align = a;
  els.alignBtns.forEach(b=>{
    const on = b.dataset.align===a;
    b.classList.toggle('active',on); b.setAttribute('aria-pressed',on)
  });
  const flex = {left:'flex-start',center:'center',right:'flex-end'}[a];
  els.content.style.alignItems = flex;
  els.poster.style.textAlign = a;
  persist();
}
function applyPad(){ document.documentElement.style.setProperty('--pad', state.pad + 'px'); positionWatermark(); autoFit(); persist(); }
function applyRatio(r){
  const map={'1:1':100,'4:5':125,'9:16':177.78,'16:9':56.25};
  els.ratioSpacer.style.paddingTop = map[r] + '%';
  requestAnimationFrame(autoFit);
  persist();
}
function applyColors(){ els.poster.style.color = els.fgPicker.value; els.poster.style.background = els.bgPicker.value; }
function applyFont(){
  els.headline.style.fontFamily = els.fontFamily.value; els.author.style.fontFamily = "Inter, sans-serif";
  requestAnimationFrame(autoFit); persist();
}
function applyShadow(){ els.poster.classList.toggle('glow', state.shadow); persist(); }

/* ------ Watermark ------ */
function setWmPos(pos){
  state.wmPos = pos;
  els.wmChoices.forEach(b=>{
    const on = b.dataset.pos===pos;
    b.classList.toggle('active', on);
    b.setAttribute('aria-pressed', on);
  });
  positionWatermark(); persist();
}
function positionWatermark(){
  const pad = getComputedStyle(document.documentElement).getPropertyValue('--pad').trim();
  const style = els.wmark.style;
  style.top = 'auto'; style.left='auto'; style.right='auto'; style.bottom='var(--pad)';
  if(state.wmPos==='bl'){ style.left = pad; style.transform='none'; }
  if(state.wmPos==='bc'){ style.left = '50%'; style.transform='translateX(-50%)'; }
  if(state.wmPos==='br'){ style.right = pad; style.transform='none'; }
  els.wmark.classList.toggle('hidden', !els.wmToggle.checked);
}

/* ------ Auto-fit (Polished) ------ */
function autoFit(){
  const H = els.poster.clientHeight, pad = parseFloat(getComputedStyle(els.poster).paddingTop);
  const authorH = els.author.offsetHeight||20, reserve = els.wmToggle.checked?22:0;
  // Calculate available vertical space with a small buffer
  const available = H - (pad * 2) - authorH - reserve - 12;

  // Start with the user's *preferred* size from state
  let size = clamp(state.size, 24, 200);
  els.headline.style.fontSize = size+'px';

  let guard = 200; // Max iterations

  // 1. If it's too big, shrink it down
  while(els.headline.scrollHeight > available && size > 24 && guard--){
    size -= 1;
    els.headline.style.fontSize = size+'px';
  }

  // 2. If it's too small (and *smaller* than user's pref), grow it
  guard = 100; // Reset guard
  // Grow *only* up to the user's preferred state.size
  while(els.headline.scrollHeight <= available && size < state.size && size < 200 && guard--) {
     size += 1;
     els.headline.style.fontSize = size+'px';
  }

  // 3. After growing, it might be one step too large. Check and step back.
  if (els.headline.scrollHeight > available && size > 24) {
      size -= 1;
      els.headline.style.fontSize = size+'px';
  }

  // 4. Update the slider knob to reflect the *actual* rendered size.
  //    Crucially, we DON'T update state.size here.
  els.sizeInput.value = size;
}


/* ------ Persistence ------ */
const KEY='quotesn_pro_post_v3';
function persist(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
function restore(){
  try{
    const s = JSON.parse(localStorage.getItem(KEY)||'{}');
    Object.assign(state, s);
  }catch(e){}
}

/* ------ Export ------ */
async function exportImg(type='png'){
  try{
    say('Rendering…'); await document.fonts.ready;
    const scale = els.retinaToggle.checked ? 2 : 1;
    const canvas = await html2canvas(els.poster,{
      backgroundColor: (type==='png'?'transparent':null),
      scale, useCORS:true
    });
    const mime = type==='jpeg'?'image/jpeg':(type==='webp'?'image/webp':'image/png');
    const url = canvas.toDataURL(mime, 0.98);
    const a=document.createElement('a');
    const date=new Date().toISOString().slice(0,10);
    a.href=url; a.download=`${date}-${state.ratio}-${THEMES[state.theme].name.replace(/\s+/g,'_')}.${type==='jpeg'?'jpg':type}`;
    a.click();
    say('Downloaded ✔');
  }catch(e){ console.error(e); say('Export failed'); }
}

/* ------ Share ------ */
async function shareImg(){
  try{
    say('Preparing share…'); await document.fonts.ready;
    const scale = els.retinaToggle.checked ? 2 : 1;
    const canvas = await html2canvas(els.poster,{ backgroundColor:null, scale, useCORS:true });
    const blob = await new Promise(res=>canvas.toBlob(res,'image/png',0.95));
    const file = new File([blob],'quote.png',{type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'Quote Poster',text:'Made with Quotesn'});
    }else{
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='quote.png'; a.click(); URL.revokeObjectURL(url);
    }
  }catch(e){ console.error(e); say('Share not supported'); }
}

/* ------ Events ------ */
els.quoteInput.addEventListener('input',()=>{
  els.headline.textContent = els.quoteInput.value;
  // Auto detect RTL for Arabic/Urdu/Hebrew
  const rtl = isRTL(els.quoteInput.value);
  els.headline.dir = rtl ? 'rtl' : 'ltr';
  autoFit();
});
els.authorInput.addEventListener('input',()=>{ els.author.textContent = els.authorInput.value; autoFit(); });

els.fontFamily.addEventListener('change',applyFont);
els.sizeInput.addEventListener('input',e=>{ state.size=+e.target.value; persist(); autoFit(); });
els.padInput.addEventListener('input',e=>{ state.pad=+e.target.value; applyPad(); });

els.alignBtns.forEach(b=>b.addEventListener('click',()=>{ applyAlign(b.dataset.align); }));

els.themeSelect.addEventListener('change',e=>{ state.theme=+e.target.value; applyTheme(state.theme); });

/* --- Patched Listeners --- */
els.toggleTheme.addEventListener('click', () => {
  setActiveIcon(els.toggleTheme);
  state.theme = (state.theme + 1) % THEMES.length;
  applyTheme(state.theme);
});
els.themeNextBtn.addEventListener('click',()=>{ state.theme=(state.theme+1)%THEMES.length; applyTheme(state.theme); });

els.bgPicker.addEventListener('input',applyColors);
els.fgPicker.addEventListener('input',applyColors);
els.shadowToggle.addEventListener('change',e=>{ state.shadow=e.target.checked; applyShadow(); });

els.wmText.addEventListener('input',()=>{ els.wmark.textContent = els.wmText.value; });
els.wmToggle.addEventListener('change',positionWatermark);
els.wmChoices.forEach(btn=>btn.addEventListener('click',()=>setWmPos(btn.dataset.pos)));

els.ratioSelect.addEventListener('change',e=>{ state.ratio=e.target.value; applyRatio(state.ratio); }); 

/* --- Patched Listeners --- */
els.exportBtn.addEventListener('click', () => {
  setActiveIcon(els.exportBtn);
  els.exportMenu.classList.toggle('hidden');
});
document.addEventListener('click',e=>{
  if(!els.exportBtn.contains(e.target) && !els.exportMenu.contains(e.target)) els.exportMenu.classList.add('hidden');
  if(!els.downloadBtn.contains(e.target) && !els.exportMenu2.contains(e.target)) els.exportMenu2.classList.add('hidden');
});
els.exportMenu.addEventListener('click',e=>{ const t=e.target.dataset.type; if(t){ els.exportMenu.classList.add('hidden'); exportImg(t);} });
els.downloadBtn.addEventListener('click',()=>els.exportMenu2.classList.toggle('hidden'));
els.exportMenu2.addEventListener('click',e=>{ const t=e.target.dataset.type; if(t){ els.exportMenu2.classList.add('hidden'); exportImg(t);} });

/* --- Patched Listeners --- */
els.shareBtn.addEventListener('click', () => {
  setActiveIcon(els.shareBtn);
  shareImg();
});
window.addEventListener('resize',()=>requestAnimationFrame(autoFit));

/* Keyboard shortcuts */
document.addEventListener('keydown',e=>{
  if (e.target.matches('input,textarea')) return;
  if (e.key==='t' || e.key==='T'){ els.toggleTheme.click(); }
  if (e.key==='d' || e.key==='D'){ exportImg('png'); }
  if (e.key==='s' || e.key==='S'){ shareImg(); }
});

/* Build theme UI */
function buildThemeUI(){
  els.themeSelect.innerHTML = THEMES.map((t,i)=>`<option value="${i}">${t.name}</option>`).join('');
  els.themeGrid.innerHTML='';
  THEMES.forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='swatch w-full'; b.style.background=t.bg; b.title=t.name;
    b.addEventListener('click',()=>{ state.theme=i; applyTheme(i); });
    els.themeGrid.appendChild(b);
  });
}

/* Init */
(function init(){
  restore(); // load previous
  buildThemeUI();
  // Ensure initial theme index is valid
  if (state.theme >= THEMES.length) {
    state.theme = 0;
  }
  applyTheme(state.theme);
  applyAlign(state.align);
  applyPad(); applyRatio(state.ratio); applyFont(); applyShadow();
  els.sizeInput.value = state.size; // Set slider to stored value
  els.padInput.value = state.pad;
  setWmPos(state.wmPos||'br');
  els.wmark.textContent = els.wmText.value;
  positionWatermark();
  els.quoteInput.dispatchEvent(new Event('input')); // Triggers initial text content and autoFit
  requestAnimationFrame(autoFit); // Final check
  say('Ready ✨');
})();
</script>
</body>
</html>
